# Import libraries
import tensorflow as tf
import tensorflow_datasets as tfds
import matplotlib.pyplot as plt
import numpy as np
from tqdm import tqdm

# Step 1: Load MNIST dataset
data = tfds.load('mnist', split='train', shuffle_files=True)
data = data.map(lambda x: tf.cast(x['image'], tf.float32) / 255.0)
data = data.batch(64)

# Step 2: Define parameters
IMG_SHAPE = (28, 28, 1)
BATCH_SIZE = 64
NUM_DIFFUSION_STEPS = 1000
BETA_START = 1e-4
BETA_END = 0.02
betas = np.linspace(BETA_START, BETA_END, NUM_DIFFUSION_STEPS)
alphas = 1 - betas
alpha_bars = np.cumprod(alphas)

# Step 3: Define forward diffusion process (adding noise)
def forward_diffusion_sample(x_0, t):
    # Ensure alpha_bars[t] is a float32 Tensor
    sqrt_alpha_bar = tf.cast(tf.sqrt(tf.constant(alpha_bars[t])), tf.float32)
    sqrt_one_minus_alpha_bar = tf.cast(tf.sqrt(tf.constant(1 - alpha_bars[t])), tf.float32)

    # Ensure image and noise are float32
    x_0 = tf.cast(x_0, tf.float32)
    noise = tf.cast(tf.random.normal(shape=x_0.shape), tf.float32)

    # Combine them
    return sqrt_alpha_bar * x_0 + sqrt_one_minus_alpha_bar * noise, noise

# Step 4: Visualize noisy images
example = next(iter(data))[0:5]
timesteps = [10, 100, 500, 999]

plt.figure(figsize=(12, 3))
for idx, t in enumerate(timesteps):
    noisy, _ = forward_diffusion_sample(example, t)
    plt.subplot(1, 4, idx + 1)
    plt.imshow(noisy[0, :, :, 0], cmap='gray')
    plt.title(f"Step {t}")
    plt.axis('off')
plt.show()

# Step 5: Load a small pre-trained DDPM model from TensorFlow Hub (for inference)
# If you don't have a pre-trained one, simulate the denoising with a simple CNN
from tensorflow.keras import layers, models

def build_simple_denoiser():
    model = models.Sequential([
        layers.Input(shape=IMG_SHAPE),
        layers.Conv2D(32, 3, activation='relu', padding='same'),
        layers.Conv2D(32, 3, activation='relu', padding='same'),
        layers.Conv2D(1, 3, activation='sigmoid', padding='same')
    ])
    return model

denoiser = build_simple_denoiser()

# Step 6: Simulate reverse process (denoising random noise)
def sample_image(model, steps):
    img = tf.random.normal((1, 28, 28, 1), dtype=tf.float32)
    for i in reversed(range(steps)):
        t = tf.constant([i], dtype=tf.int32)
        pred_noise = model(img, training=False)  # âœ… fixed
        img = img - 0.01 * pred_noise  # simplified update
    return img



# Step 7: Generate and visualize a new image
generated_img = sample_image(denoiser, steps=200)
plt.imshow(generated_img[0, :, :, 0], cmap='gray')
plt.title("Generated Image from Noise")
plt.axis('off')
plt.show()